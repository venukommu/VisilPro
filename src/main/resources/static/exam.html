<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisilPro - Exam Session</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --border-color: #334155;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 24px;
            flex-shrink: 0;
            z-index: 10;
        }

        .brand {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 32px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .brand span { color: var(--accent-color); }

        .info-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .info-item {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-item:last-child { margin-bottom: 0; }

        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0;
        }

        .info-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        #timer {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            margin: 0 0 24px 0;
            font-variant-numeric: tabular-nums;
        }

        .log-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0; /* For flex scrolling */
            margin-bottom: 24px;
        }

        .log-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #warningList {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 8px;
        }

        #warningList li {
            font-size: 12px;
            padding: 8px 12px;
            margin-bottom: 8px;
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--danger-color);
            border-radius: 4px;
            color: #fca5a5;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .btn-submit {
            width: 100%;
            padding: 14px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-submit:hover {
            background-color: var(--accent-hover);
        }

        /* Main Content */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .top-bar {
            height: 64px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 32px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
        }

        .content-area {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        /* Video Section */
        #video-section {
            width: 400px;
            padding: 24px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background: #162032;
        }

        #video-container {
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 2px solid var(--border-color);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .live-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Form Section */
        #form-section {
            flex-grow: 1;
            padding: 40px;
            overflow-y: auto;
            max-width: 900px;
            margin: 0 auto;
        }

        .question-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .question-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .option-label {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-label:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-color);
        }

        input[type="radio"] {
            margin-right: 12px;
            accent-color: var(--accent-color);
        }

        textarea, input[type="email"], input[type="text"] {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Alert Overlay */
        #malpracticeAlert {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            font-weight: 500;
            backdrop-filter: blur(4px);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .modal-text {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-secondary {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-primary {
            padding: 10px 20px;
            background: var(--accent-color);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        /* Progress Bar */
        .progress-container {
            height: 4px;
            background: var(--border-color);
            width: 100%;
            position: absolute;
            bottom: 0;
            left: 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--success-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Malpractice Feedback */
        .malpractice-detected {
            border-color: var(--danger-color) !important;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2) !important;
        }

    </style>
</head>
<body>
    <!-- Alert Overlay -->
    <!-- Alert Overlay Removed -->

    <!-- Submission Modal -->
    <div id="submissionModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-title">Submit Assessment?</div>
            <p class="modal-text">You are about to submit your exam. This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="confirmSubmit()">Submit Exam</button>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div class="brand">Visil<span>Pro</span></div>
        
        
        <div class="info-card">
            <div class="info-item">
                <div class="info-label">Student ID:</div>
                <div class="info-value" id="displayStudentId">Loading...</div>
            </div>
            <div class="info-item" style="margin-top: 12px;">
                <div class="info-label">Session ID:</div>
                <div class="info-value" id="displaySessionId" style="color: var(--accent-color);">Initializing...</div>
            </div>
            <div class="info-item" style="margin-top: 12px;">
                <div class="info-label">Status:</div>
                <div class="info-value" id="connectionStatus" style="color: var(--success-color);">‚óè Active Monitoring</div>
            </div>
        </div>

        <div id="timer">00:45:00</div>

        <div class="log-section">
            <div class="log-header">
                <span>Malpractice Detection</span>
                <span style="font-size: 10px; opacity: 0.7;">LIVE</span>
            </div>
            <ul id="warningList">
                <!-- Warnings will appear here -->
            </ul>
        </div>

        <button class="btn-submit" onclick="endExam()">Submit Assessment</button>
    </div>

    <div id="main-content">
        <div class="top-bar">
            <div class="page-title">General Assessment - Batch 2025</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <div class="content-area">
            <!-- Video Feed (Sticky/Fixed) -->
            <div id="video-section">
                <div id="video-container">
                    <video id="video" autoplay muted></video>
                    <div class="live-badge"><div class="live-dot"></div> Live</div>
                    <!-- Canvas will be appended here -->
                </div>
                <div style="margin-top: 20px; font-size: 13px; color: var(--text-secondary); text-align: center;">
                    <p>Ensure your face is clearly visible at all times.</p>
                    <p style="margin-top: 4px;">Microphone is active.</p>
                </div>
            </div>

            <!-- Exam Form (Scrollable) -->
            <div id="form-section">
                <div class="question-card">
                    <div class="question-title">1. Which of the following is NOT a Java keyword?</div>
                    <label class="option-label"><input type="radio" name="q1" value="a"> static</label>
                    <label class="option-label"><input type="radio" name="q1" value="b"> boolean</label>
                    <label class="option-label"><input type="radio" name="q1" value="c"> void</label>
                    <label class="option-label"><input type="radio" name="q1" value="d"> integer</label>
                </div>

                <div class="question-card">
                    <div class="question-title">2. What is the time complexity of binary search?</div>
                    <label class="option-label"><input type="radio" name="q2" value="a"> O(n)</label>
                    <label class="option-label"><input type="radio" name="q2" value="b"> O(log n)</label>
                    <label class="option-label"><input type="radio" name="q2" value="c"> O(n^2)</label>
                    <label class="option-label"><input type="radio" name="q2" value="d"> O(1)</label>
                </div>

                <div class="question-card">
                    <div class="question-title">3. Describe the principle of Encapsulation.</div>
                    <textarea rows="4" placeholder="Type your answer here..."></textarea>
                </div>

                <div class="question-card">
                    <div class="question-title">4. Enter your Email Address for results:</div>
                    <input type="email" placeholder="student@example.com">
                </div>

                <div class="question-card">
                    <div class="question-title">5. Additional Comments:</div>
                    <textarea rows="3" placeholder="Any feedback?"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/face-api.min.js"></script>
    <script>
        const video = document.getElementById('video');
        const videoContainer = document.getElementById('video-container');
        const studentId = localStorage.getItem('studentId') || 'Unknown';
        document.getElementById('displayStudentId').innerText = studentId;
        
        let examSessionId = null;
        let isExamActive = true;

        // Start Exam Session
        async function startExamSession() {
            try {
                const response = await fetch('/api/exam/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId: studentId, examCode: 'EXAM-001' })
                });
                const session = await response.json();
                examSessionId = session.id;
                document.getElementById('displaySessionId').innerText = examSessionId;
                console.log("Exam Session Started:", examSessionId);
            } catch (err) {
                console.error("Failed to start session:", err);
            }
        }

        // Load Models
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('/models')
        ]).then(startVideo);

        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {}, audio: true });
                video.srcObject = stream;
                
                // Audio Context Setup
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const microphone = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                microphone.connect(analyser);
                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                // Audio Detection Loop
                setInterval(() => {
                    if (!isExamActive) return;
                    analyser.getByteFrequencyData(dataArray);
                    const volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    
                    if (volume > 50) { // Threshold for loud noise
                        handleMalpractice("AUDIO_DETECTED", "Suspicious audio detected.");
                    }
                }, 1000);

                await startExamSession();
            } catch (err) {
                console.error("Error accessing webcam/microphone:", err);
                alert("Please enable webcam and microphone access to continue.");
            }
        }

        video.addEventListener('play', () => {
            const canvas = faceapi.createCanvasFromMedia(video);
            videoContainer.append(canvas);
            const displaySize = { width: videoContainer.clientWidth, height: videoContainer.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            let missingFaceFrames = 0;

            setInterval(async () => {
                if (!isExamActive) return;

                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                faceapi.draw.drawDetections(canvas, resizedDetections);
                // faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

                // Malpractice Detection Logic
                if (detections.length === 0) {
                    missingFaceFrames++;
                    if (missingFaceFrames >= 3) {
                        handleMalpractice("FACE_NOT_VISIBLE", "No face detected in frame.");
                    }
                } else {
                    missingFaceFrames = 0; // Reset counter if face is found
                    
                    if (detections.length > 1) {
                        handleMalpractice("MULTIPLE_FACES", "Multiple faces detected.");
                    } else {
                        // Gaze/Head Pose Estimation (Simplified)
                        const landmarks = detections[0].landmarks;
                        const nose = landmarks.getNose()[0];
                        const leftEye = landmarks.getLeftEye()[0];
                        const rightEye = landmarks.getRightEye()[0];
                        
                        // Simple logic: if nose is too far left or right relative to eyes
                        // This is a rough approximation for looking away
                        const eyeCenter = (leftEye.x + rightEye.x) / 2;
                        const deviation = Math.abs(nose.x - eyeCenter);
                        
                        if (deviation > 40) { // Threshold needs tuning
                            handleMalpractice("LOOKING_AWAY", "Student looking away.");
                        }
                    }
                }
            }, 1000); // Check every second
        });

        // Tab Switching / Focus Lost Detection
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && isExamActive) {
                handleMalpractice("FOCUS_LOST", "Student switched tabs or minimized window.");
            }
        });

        let lastAlertTime = 0;
        async function handleMalpractice(type, message) {
            const now = Date.now();
            if (now - lastAlertTime < 5000) return; // Debounce alerts (5 seconds)

            lastAlertTime = now;
            
            // Alert Overlay removed as per request
            // const alertBox = document.getElementById('malpracticeAlert');
            // document.getElementById('alertMessage').innerText = message;
            // alertBox.style.display = 'block';
            // setTimeout(() => alertBox.style.display = 'none', 3000);

            // Add to persistent log
            const logList = document.getElementById('warningList');
            const entry = document.createElement('li');
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${message}`;
            logList.prepend(entry);

            // Log to Backend
            if (examSessionId) {
                try {
                    await fetch('/api/exam/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: examSessionId,
                            type: type,
                            confidenceScore: 0.95,
                            snapshotUrl: "snapshot_placeholder.jpg" // In real app, send base64 image
                        })
                    });
                    console.log("Malpractice logged:", type);
                } catch (err) {
                    console.error("Failed to log malpractice:", err);
                }
            }
        }

        // Progress Bar Logic
        const totalQuestions = 5; // Update this based on actual number of questions
        const formSection = document.getElementById('form-section');
        const progressBar = document.getElementById('progressBar');

        formSection.addEventListener('input', updateProgress);

        function updateProgress() {
            // Count answered questions (simplified logic)
            let answered = 0;
            
            // Check radios
            const q1 = document.querySelector('input[name="q1"]:checked');
            if (q1) answered++;
            
            const q2 = document.querySelector('input[name="q2"]:checked');
            if (q2) answered++;

            // Check textareas/inputs
            const textInputs = formSection.querySelectorAll('textarea, input[type="email"], input[type="text"]');
            textInputs.forEach(input => {
                if (input.value.trim().length > 0) answered++;
            });

            const percentage = (answered / totalQuestions) * 100;
            progressBar.style.width = `${percentage}%`;
        }

        // Timer Logic
        let timeLeft = 45 * 60; // 45 minutes in seconds
        const timerElement = document.getElementById('timer');

        function updateTimer() {
            if (!isExamActive) return;
            
            const hours = Math.floor(timeLeft / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = timeLeft % 60;

            timerElement.innerText = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (timeLeft > 0) {
                timeLeft--;
            } else {
                endExam();
            }
        }

        setInterval(updateTimer, 1000);

        function endExam() {
            document.getElementById('submissionModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('submissionModal').style.display = 'none';
        }

        function confirmSubmit() {
            isExamActive = false;
            // In a real app, you would submit the form data here
            window.location.href = 'index.html';
        }

        // Visual Feedback for Malpractice
        function triggerVisualAlert() {
            videoContainer.classList.add('malpractice-detected');
            setTimeout(() => {
                videoContainer.classList.remove('malpractice-detected');
            }, 3000);
        }

        // Update handleMalpractice to trigger visual alert
        const originalHandleMalpractice = handleMalpractice;
        handleMalpractice = async function(type, message) {
            triggerVisualAlert();
            // Call the original function logic (we need to duplicate it or refactor, 
            // since I can't easily wrap the async function defined above without redefining it completely 
            // or changing the previous definition. Let's redefine it for clarity in this edit).
            
            const now = Date.now();
            if (now - lastAlertTime < 5000) return; // Debounce alerts (5 seconds)

            lastAlertTime = now;
            
            // Add to persistent log
            const logList = document.getElementById('warningList');
            const entry = document.createElement('li');
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${message}`;
            logList.prepend(entry);

            // Log to Backend
            if (examSessionId) {
                try {
                    await fetch('/api/exam/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: examSessionId,
                            type: type,
                            confidenceScore: 0.95,
                            snapshotUrl: "snapshot_placeholder.jpg"
                        })
                    });
                    console.log("Malpractice logged:", type);
                } catch (err) {
                    console.error("Failed to log malpractice:", err);
                }
            }
        };
    </script>
</body>
</html>
